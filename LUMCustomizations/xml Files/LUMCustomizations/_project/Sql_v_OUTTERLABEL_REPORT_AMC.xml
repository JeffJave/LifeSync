<Sql TableName="v_OUTTERLABEL_REPORT_AMC" CustomScript="#CDATA">
    <CDATA name="CustomScript"><![CDATA[IF EXISTS
(
	SELECT *
	FROM SYS.views
	WHERE name = 'v_OUTTERLABEL_REPORT_AMC' AND SCHEMA_ID = SCHEMA_ID('dbo')
)
DROP VIEW [dbo].[v_OUTTERLABEL_REPORT_AMC]	
GO
CREATE VIEW v_OUTTERLABEL_REPORT_AMC AS
with calculateReult as (
SELECT t.CompanyID,
	   ShipmentPlanID,
	   t.InventoryID,
	   Customer,
	   CustomerOrderNbr,
	   LotSerialNbr,
	   ProdLine,
	   PlannedShipDate,
	   PlannedShipQty,
	   NowNbr AS StartLabelNbr,
	   CEILING((CAST(ISNULL(c.QTYCARTON,1) AS INT) / CAST(ISNULL(c.QTYSBOX,1) AS INT)) / (t.PlannedShipQty/CAST(ISNULL(c.QTYSBOX,1) AS INT))) AS EndLabelNbr
FROM LumShipmentPlan t
INNER JOIN InventoryItem i ON t.CompanyID = i.CompanyID 
						  AND t.InventoryID = i.InventoryID
INNER JOIN (select p.*
			from (select CompanyID,RefNoteID,AttributeID,Value 
				  from CSAnswers ) t
			pivot (
				max (Value)
				for AttributeID IN (QTYSBOX,QTYCARTON) )p) c ON i.CompanyID = c.CompanyID
															AND i.NoteID = c.RefNoteID
CROSS JOIN(
	SELECT DISTINCT NUMBER AS NowNbr
    FROM master.dbo.spt_values
    WHERE name IS NULL
) NumberPool
WHERE NowNbr BETWEEN t.StartLabelNbr AND CEILING((CAST(ISNULL(c.QTYCARTON,1) AS INT) / CAST(ISNULL(c.QTYSBOX,1) AS INT)) / (t.PlannedShipQty/CAST(ISNULL(c.QTYSBOX,1) AS INT)))
)
select t.CompanyID,
	   t.ShipmentPlanID,
	   t.InventoryID,
	   Customer,
	   CustomerOrderNbr,
	   LotSerialNbr,
	   ProdLine,
	   PlannedShipDate,
	   PlannedShipQty,
	   StartLabelNbr,
	   CAST(p.EndLabelNbr AS INT) AS EndLabelNbr
from calculateReult t
inner join (
	select p.CompanyID,
		   p.ShipmentPlanID,
		   max(p.endlabelnbr) as EndLabelNbr 
	from calculateReult p 
	group by p.CompanyID,p.ShipmentPlanID
) p on t.CompanyID = p.CompanyID and t.ShipmentPlanID = p.ShipmentPlanID]]></CDATA>
</Sql>